+++
weight = 40215
title = 'TCS3472x color sensor I2C'
katex = true
+++

![](/images/docs/sht40-sht41-sht43-sht45/sht4x.jpg)

[TCS3472x series](https://look.ams-osram.com/m/7ec5bcc3e40679be/original/TCS3472-DS000390.pdf) color sensors ...
{{% readfile "/_common/_footer/_footer-cart.md" %}}

## Connections

![alt text](/images/docs/tcs3472x/image-7.png)

|Bus Pirate|TCS3472x|Description|
|-|-|-|
|SDA|SDA|I2C Data|
|SCL|SCL|I2C Clock|
|Vout/Vref|VDD|3.3volt power supply|
|GND|GND|Ground|

These sensors are tiny and it's highly likely you're using a breakout board, like us. The important connections are the I2C data (SDA) and clock (SCL) lines, the power supply (Vout/Vref), and ground (GND).

### Breakout Boards

- Seen various
- Seem to have XYZ
- VIN seems to be a 3.3-5v supply pin with 3.3v regulator
- 3v3 is either a 3.3v supply input, or output from onboard rgulator
- LED controls LED. Nothing= LED on, hold to ground to turn LED off.

Image source: [Sensirion SHT4x Datasheet](https://look.ams-osram.com/m/7ec5bcc3e40679be/original/TCS3472-DS000390.pdf).

## See it in action

{{< asciicast src="/screencast/tcs3472x-cast.json" poster="npt:0:25"  idleTimeLimit=2 >}}

## Setup

{{< termfile source="static/snippets/tcs3472x-setup.html" >}}

SHT4x series sensors have an I2C interface, put the Bus Pirate in I2C mode.

- ```m i2c``` - set the Bus Pirate to I2C [mode]({{< relref "/docs/command-reference/#m-set-bus-mode" >}}), or just hit ```m``` to select from the menu.
- ```400``` - set the I2C bus speed to 400kHz.
- ```1``` - disable clock stretching.

### Power supply
![alt text](/images/docs/tcs3472x/image-6.png)

 requires a 1.08 to 3.6 volt power supply. 

{{< termfile source="static/snippets/tcs3472x-power.html" >}}

Letâ€™s set the Bus Pirate to power the chip at 3.3 volts, a very common voltage for current generation I2C devices.
- ```W 3.3``` - enable the [onboard power supply]({{< relref "/docs/command-reference/#ww-power-supply-offon">}}) at 3.3 volts.

### Pull-up resistors

{{< termfile source="static/snippets/tcs3472x-pullup.html" >}}

I2C is an open collector output bus, the Bus Pirate and the SHT4x can only pull the line low to 0 (ground). A pull-up resistor is needed to pull the line high to 1 (3.3 volts). The Bus Pirate has built-in pull-up resistors that can be enabled with the ```P``` command.
- ```P``` - Enable the [onboard pull-up resistors]({{< relref "/docs/command-reference/#pp-pull-up-resistors">}}).

{{% alert context="warning" %}} 
Be sure to enable the pull-up resistors. Without them, the clock data line will never go high and you'll read only 0s.
{{% /alert %}}

## I2C address scan

{{< termfile source="static/snippets/tcs3472x-scan.html" >}}

We need the correct I2C address to talk to the sensor. We could look in the datasheet, or we can run the handy [I2C address scanner]({{< relref "/docs/command-reference/#scan-i2c-address-search">}}).
- ```scan``` - Scan the I2C bus for devices

- two different addreses 0x29 (0x52 write, 0x53 read) and 0x39 (0x72 write, 0x73 read) are used by the TCS3472x series sensors. The first address is for the TCS34725 and TCS34727, the second for the TCS34721 and TCS34723. 

The scanner found an I2C device at address 0x44 (0x88 write). SHT4x doesn't reply to the corresponding I2C read address (0x89), probably because there isn't any data to read yet. 0x00 is usually a "general call" address which addresses all devices sharing the bus, we'll ignore that for now.

{{% alert context="info" %}} 
If the scanner doesn't find the device, ensure the power supply is enabled ```W 3.3``` and the pull-up resistors are enabled ```P```.
{{% /alert %}}

## Configuration

![alt text](/images/docs/tcs3472x/image-8.png)


![alt text](/images/docs/tcs3472x/image-9.png)

### Read ID Register (0x12)
![alt text](/images/docs/tcs3472x/image-10.png)

Let's read the ID register to confirm the device is working. The ID register is at address 0x12.

{{< termfile source="static/snippets/tcs3472x-read-id-convert.html" >}}

To access the ID register, we need to write the register address to the command register with the 7th bit set to 1.
- 0x12 = 0b0001'0010 - First convert the register address to binary
- 0b1001'0010 = 0x92 - Set the 7th bit to 1, then convert back to hexadecimal

{{% alert context="info" %}}
You can write the command register in binary (starts with 0b) or hexadecimal (starts with 0x). We'll stick with binary for the rest of this demo.
{{% /alert %}}

{{< termfile source="static/snippets/tcs3472x-read-id.html" >}}

Read the ID register with the typical [I2C pattern]({{< relref "/docs/command-reference/#i2c-protocol-overview">}}): write the location to read to the write address, then read data from the read address.
- ```[``` - I2C START bit, starts an I2C transaction
- ```0x52``` - Write the TCS3472x I2C write address (0x52) to the bus
- ```0b10010010``` - Write the ID register address 0x12 with the 7th bit set to 1
- ```]``` - I2C STOP bit, ends the I2C transaction
- ```[``` - I2C START bit, starts a new I2C transaction
- ```0x53``` - Write the TCS3472x I2C read address (0x53) 
- ```r``` - Read one byte from the ID register
- ```]``` - I2C STOP bit, ends the I2C transaction

The ID register contains **0x44**.

|Part|I2C Address|I2C bus voltage|ID Register|
|-|-|-|-|
|TCS3472**1**|0x39 (0x72 write, 0x73 read)|VDD|0x44|
|TCS3472**3**|0x39 (0x72 write, 0x73 read)|1.8 V|0x4D| 
|TCS3472**5**|0x29 (0x52 write, 0x53 read)|VDD|0x44|
|TCS3472**7**|0x29 (0x52 write, 0x53 read)|1.8 V|0x4D|

There are four variants of the TCS3472x series sensors. The 1 and 3 versions are a custom order part with an alternate I2C address, it's unlikely to be found outside some very specialized equipment. 

The 5 version is by far the most common on small breakouts from your favorite online retailer. The 7 version has a special low voltage I2C bus separate from the power supply, you might find these in mobile phones and other devices with a low voltage I2C bus.

With ID register 0x44 and I2C address 0x29 (0x52 write, 0x53 read), we have a common TCS34725 on this inexpensive breakout board. 

### Enable Register (0x00)

![alt text](/images/docs/tcs3472x/image.png)

{{% alert context="warning" %}}
See that note at the bottom of the screenshot? A minimum interval of 2.4 milliseconds is required between enabling the oscillator and the sensor. We're going rogue here and **we'll follow the datasheet**. Every open source driver we've seen ignores this and enables both at the same time, which seems to work but we'll follow the datasheet.
{{% /alert %}}

{{< termfile source="static/snippets/tcs3472x-enable-register.html" >}}

Next, we need to power the internal oscillator and then the color sensor. 

{{% alert context="info" %}}
When entering binary numbers, you can leave out any leading 0s. For example, 0b00000001 is the same as 0b1, and 0b00000011 is the same as 0b11.
{{% /alert %}}

### ALS Time Register (0x01)

![alt text](/images/docs/tcs3472x/image-1.png)

{{< termfile source="static/snippets/tcs3472x-als-time-register.html" >}}

[0x52 0x81 0x00]

### Wait Time Register (0x03)

![alt text](/images/docs/tcs3472x/image-2.png)

{{< termfile source="static/snippets/tcs3472x-wait-time-register.html" >}}

[0x52 0x83 0xff]

### Control Register (0x0F)

![alt text](/images/docs/tcs3472x/image-3.png)

Set the gain to 1x
{{< termfile source="static/snippets/tcs3472x-control-register.html" >}}

[0x52 0x8F 0x00]

## Read Color Data

![alt text](/images/docs/tcs3472x/image-5.png)

{{< term >}}
<span style="color:rgb(150,203,89)">I2C></span>&nbsp;[0x52&nbsp;0b10010100][0x53&nbsp;r:8]

I2C&nbsp;START
<span style="color:rgb(191,165,48)">TX:</span>&nbsp;0x<span style="color:rgb(83,166,230)">52</span>&nbsp;ACK&nbsp;
<span style="color:rgb(191,165,48)">TX:</span>&nbsp;0b<span style="color:rgb(83,166,230)">1001</span>0100&nbsp;ACK&nbsp;
I2C&nbsp;STOP
I2C&nbsp;START
<span style="color:rgb(191,165,48)">TX:</span>&nbsp;0x<span style="color:rgb(83,166,230)">53</span>&nbsp;ACK&nbsp;
<span style="color:rgb(191,165,48)">RX:</span>&nbsp;0x<span style="color:rgb(83,166,230)">AA</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">02</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">DB</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">01</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">7A</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">00</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">63</span>&nbsp;ACK&nbsp;0x<span style="color:rgb(83,166,230)">00</span>&nbsp;NACK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
I2C&nbsp;STOP
<span style="color:rgb(150,203,89)">I2C></span>&nbsp;
{{< /term >}}

[0x52 0x94][0x53 r:8]

Registers 0x14 to 0x1B contain the color data. The first two bytes are the clear channel, the next two bytes are red, then green, and finally blue.




## Get a Bus Pirate

{{% readfile "/_common/_footer/_footer-get.md" %}}

### Community

{{% readfile "/_common/_footer/_footer-community.md" %}}